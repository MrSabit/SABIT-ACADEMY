name: Render PostgreSQL Backup

on:
  schedule:
    - cron: "0 2 * * *"
  workflow_dispatch:

jobs:
  backup:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - uses: actions/checkout@v4

      - name: Install PostgreSQL client
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client postgresql-common jq

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install google-api-python-client google-auth google-auth-httplib2 google-auth-oauthlib

      - name: Create database dump
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
        run: |
          set -e
          TS=$(date -u +"%Y%m%d-%H%M%S")
          NAME="render-postgres-backup-${TS}.dump.gz"
          
          # Use Render API to create backup
          if [ -n "$RENDER_API_KEY" ] && [ -n "$RENDER_SERVICE_ID" ]; then
            echo "Using Render API backup..."
            echo "Creating backup for service: $RENDER_SERVICE_ID"
            
            # Create backup and capture full response
            BACKUP_RESPONSE=$(curl -s -X POST \
              -H "Authorization: Bearer $RENDER_API_KEY" \
              -H "Content-Type: application/json" \
              -d '{"serviceName":"'$RENDER_SERVICE_ID'"}' \
              https://api.render.com/v1/services/$RENDER_SERVICE_ID/backups)
            
            echo "Backup creation response: $BACKUP_RESPONSE"
            
            # Try to extract backup ID from response
            BACKUP_ID=$(echo "$BACKUP_RESPONSE" | jq -r '.id // .backupId // empty')
            
            if [ -z "$BACKUP_ID" ] || [ "$BACKUP_ID" = "null" ]; then
              echo "Failed to get backup ID from response. Response was: $BACKUP_RESPONSE"
              echo "Falling back to pg_dump..."
              pg_dump --no-owner --no-privileges --format=custom --ignore-version "$DATABASE_URL" | gzip -c > "$NAME"
            else
              echo "Backup created with ID: $BACKUP_ID"
              
              # Wait for backup to complete
              echo "Waiting for backup to complete..."
              sleep 30
              
              # Get backup details
              BACKUP_DETAILS=$(curl -s -H "Authorization: Bearer $RENDER_API_KEY" \
                "https://api.render.com/v1/backups/$BACKUP_ID")
              echo "Backup details: $BACKUP_DETAILS"
              
              # Try to get download URL
              DOWNLOAD_URL=$(echo "$BACKUP_DETAILS" | jq -r '.url // .downloadUrl // empty')
              
              if [ -z "$DOWNLOAD_URL" ] || [ "$DOWNLOAD_URL" = "null" ]; then
                echo "Failed to get download URL. Details: $BACKUP_DETAILS"
                echo "Falling back to pg_dump..."
                pg_dump --no-owner --no-privileges --format=custom --ignore-version "$DATABASE_URL" | gzip -c > "$NAME"
              else
                echo "Downloading backup from: $DOWNLOAD_URL"
                curl -s "$DOWNLOAD_URL" -o "$NAME"
              fi
            fi
          else
            echo "Render API keys not set, falling back to pg_dump..."
            pg_dump --no-owner --no-privileges --format=custom --ignore-version "$DATABASE_URL" | gzip -c > "$NAME"
          fi
          
          echo "BACKUP_FILE=$NAME" >> $GITHUB_ENV
          echo "BACKUP_PREFIX=render-postgres-backup-" >> $GITHUB_ENV
          echo "Backup file size: $(stat -c%s "$NAME" || echo 'unknown')"

      - name: Upload to Google Drive + retention
        env:
          GDRIVE_CLIENT_SECRET_JSON: ${{ secrets.GDRIVE_CLIENT_SECRET_JSON }}
          GDRIVE_REFRESH_TOKEN: ${{ secrets.GDRIVE_REFRESH_TOKEN }}
          GDRIVE_FOLDER_ID: ${{ secrets.GDRIVE_FOLDER_ID }}
        run: |
          python tools/drive_backup_oauth.py --file "$BACKUP_FILE" --name "$BACKUP_FILE" --prefix "$BACKUP_PREFIX" --keep-last 30
