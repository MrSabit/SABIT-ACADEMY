name: Render PostgreSQL Backup

on:
  schedule:
    - cron: "0 2 * * *"
  workflow_dispatch:

jobs:
  backup:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - uses: actions/checkout@v4

      - name: Install PostgreSQL client
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client postgresql-common

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install google-api-python-client google-auth google-auth-httplib2 google-auth-oauthlib

      - name: Create database dump
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          set -e
          TS=$(date -u +"%Y%m%d-%H%M%S")
          NAME="render-postgres-backup-${TS}.dump.gz"
          
          # Extract connection info from DATABASE_URL
          DB_HOST=$(echo "$DATABASE_URL" | sed -n 's/.*@\([^:]*\):.*/\1/p')
          DB_PORT=$(echo "$DATABASE_URL" | sed -n 's/.*:\([0-9]*\)\/.*/\1/p')
          DB_NAME=$(echo "$DATABASE_URL" | sed -n 's/.*\/\([^?]*\).*/\1/p')
          DB_USER=$(echo "$DATABASE_URL" | sed -n 's/.*:\/\/\([^:]*\):.*/\1/p')
          DB_PASS=$(echo "$DATABASE_URL" | sed -n 's/.*:\([^@]*\)@.*/\1/p')
          
          echo "Creating database dump using PostgreSQL 18 Docker..."
          echo "Host: $DB_HOST, Port: $DB_PORT, User: $DB_USER, DB: $DB_NAME"
          
          # Use Docker with PostgreSQL 18 and force TCP connection
          docker run --rm \
            -e PGPASSWORD="$DB_PASS" \
            postgres:18 \
            pg_dump -h "$DB_HOST" -p "$DB_PORT" -U "$DB_USER" \
            --no-owner --no-privileges --format=custom \
            --host="$DB_HOST" --port="$DB_PORT" "$DB_NAME" | gzip -c > "$NAME"
          
          echo "BACKUP_FILE=$NAME" >> $GITHUB_ENV
          echo "BACKUP_PREFIX=render-postgres-backup-" >> $GITHUB_ENV
          echo "Backup file size: $(stat -c%s "$NAME" || echo 'unknown')"

      - name: Upload to Google Drive + retention
        env:
          GDRIVE_CLIENT_SECRET_JSON: ${{ secrets.GDRIVE_CLIENT_SECRET_JSON }}
          GDRIVE_REFRESH_TOKEN: ${{ secrets.GDRIVE_REFRESH_TOKEN }}
          GDRIVE_FOLDER_ID: ${{ secrets.GDRIVE_FOLDER_ID }}
        run: |
          python tools/drive_backup_oauth.py --file "$BACKUP_FILE" --name "$BACKUP_FILE" --prefix "$BACKUP_PREFIX" --keep-last 30
